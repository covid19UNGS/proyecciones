---
title: "Proyecciones y estimaciones de tiempo de duplicación"
author: Grupo covid19UNGS
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    theme: readable
    toc: yes
    toc_depth: 2
    toc_float: true
editor_options: 
  chunk_output_type: console
bibliography: Epidemics.bib
---

```{r setup, include=FALSE,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

needed_packages <- c(
    "tidyverse"
  , "lubridate"
  , "EpiEstim"
  , "incidence"
  , "projections"
  , "epitrix"
  , "distcrete")

lapply(needed_packages, function(x) { if(!require(x,character.only = TRUE)) install.packages(x)} )

theme_set(theme_bw())
source("R/functions.r")

#csv_fname <- "https://raw.githubusercontent.com/lsaravia/covid19ar/master/coronavirus_ar.csv"
csv_fname <- "Data/coronavirus_ar.csv"


cor <- read_csv(csv_fname) %>% dplyr::select(fecha:TDFdia)
cor <- cor  %>% mutate(fecha=ymd(fecha), dias =as.numeric( fecha - min(fecha))) 
cor <- cor %>% mutate(importadosdia=importados-lag(importados))
cor$importadosdia[1] <- 1
cor <- cor %>% mutate(localesdia=casosdia - importadosdia, CABAdia=ifelse(is.na(CABAdia),0,CABAdia))

# Datos de Casos de Gobierno Nacional 
#
csv_fname1 <- "Data/Covid19Casos.csv"

url <- "https://sisa.msal.gov.ar/datos/descargas/covid-19/files/Covid19Casos.csv"

if( Sys.which("wget")!="" ) {
  setwd("Data")
  system(paste("wget -q -N", url)) 
  setwd("..")
} else {
  download.file(url, destfile = csv_fname1)
}


#x_utf16 <- readBin(csv_fname1, "raw", n = file.size(csv_fname1))
#
#x_utf8 <- iconv(list(x_utf16), from = "UTF-16LE", to = "UTF-8", toRaw = TRUE)[[1]]
#
#cor_nac <- read_csv(x_utf8)
#
#rm(x_utf16,x_utf8)

cor_nac <- read.csv(csv_fname1,stringsAsFactors = FALSE,fileEncoding = "ISO-8859-1",skipNul = TRUE) %>% mutate(residencia_provincia_nombre=ifelse(residencia_provincia_nombre=="SIN ESPECIFICAR",carga_provincia_nombre,residencia_provincia_nombre))

```


# Estimación de cambios en el número reproductivo efectivo $R_t$

* Datos a partir de los reportes del Ministerio de Salud

El valor de $R_t$ representa el número esperado de casos secundarios que surgen de un caso primario infectado en el momento $t$. Este valor cambia a lo largo de un brote. Si el valor de $R_t$ permanece por debajo de uno, el brote se extinguirá. Sin embargo, cuando $R_t$ es mayor que uno, es probable que se produzca un brote sostenido. El objetivo de las intervenciones de control es típicamente reducir el número de reproducción por debajo de uno [@Thompson2019].

Método de estimación aplicado [@Cori2013; @Thompson2019] permite la inclusión de los casos importados y que se puede estimar el intervalo serial a partir de seguimiento de casos y también incluir variablidad en la distribucion del intervalo serial cuando se asume una distribución gamma discreta.  


* Un parametro importante es el 'Serial interval' (SI). El SI es el tiempo entre el inicio de los síntomas de cada caso de la enfermedad en cuestión, y el inicio de los síntomas en cualquier caso secundario que resulte de la transmisión de los casos primarios. En otras palabras, es el tiempo entre casos en la cadena (de ramificación) de transmisión de la enfermedad. El SI es, de hecho, una distribución estadística de tiempos de intervalo en serie, en lugar de un valor fijo. Esa distribución se puede simular, generalmente utilizando una distribución gamma discreta con una media y desviación estándar dada.

* Se utilizó un 'Serial interval' (SI) estimado por @Li2020 basado en 16 casos es de 7.5 días, con una SD=3.4, pero se permitió que la media del SI variara entre 2.3 y 8.4 usando una distribución normal truncada con una SD de 2.0, y tambien variamos la SD de la SD que variara entre 0.5 y 4.0 

* Luego se estimó el intervalo serial basandose en los datos de @He2020 (77 casos), con una media estimada en su paper de 5.8 días, aunque esta dentro de los parámetros del punto anterior estos datos serían más realistas.

```{r Refectivo, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache=TRUE,cache.extra = tools::md5sum(csv_fname)}

require(EpiEstim)

incid <- cor %>% dplyr::select(localesdia,importadosdia,fecha) %>% rename(local=localesdia,imported=importadosdia,dates=fecha)
ar_res_parametric_si <- estimate_R(incid, 
                                   method = "uncertain_si", 
                                   config = make_config(list(mean_si = 7.5, std_mean_si = 2, 
                                                             min_mean_si = 1, max_mean_si = 8.4, 
                                                             std_si = 3.4, std_std_si = 1, 
                                                             min_std_si = 0.5, max_std_si = 4, n1 = 1000, n2 = 1000))
)


plot(ar_res_parametric_si, "incid", add_imported_cases=TRUE, ) + labs(title = "Casos por dia Importados y Locales", 
        subtitle = " COVID-19, Argentina, 2020 by @larysar") + theme_bw()

plot(ar_res_parametric_si, "SI")+ theme_bw()

plot(ar_res_parametric_si, "R")+ theme_bw() + labs(title = "Nro Reproductivo Efectivo Basado en 7 días", 
        subtitle = "COVID-19, Argentina, 2020 by @larysar") + theme_bw() 

# reff_df <- tibble(fecha=ar_res_parametric_si$dates[min(ar_res_parametric_si$R$t_end):length(ar_res_parametric_si$dates)],R=ar_res_parametric_si$R$`Mean(R)`) %>% inner_join(cor) %>% mutate(terapiaDia=terapia - lag(terapia))
# 
# ggplot(cor,aes(fecha,terapia,color=log(terapia))) + geom_point() + scale_colour_distiller(palette="YlOrRd", guide = FALSE,direction= 1) + ylab("terapia intensiva") +  labs(title = " Casos COVID-19, Argentina, 2020 by @larysar")
# 
# ggplot(reff_df,aes(fecha,terapiaDia,color=log(terapia))) + geom_point() + scale_colour_distiller(palette="YlOrRd", guide = FALSE,direction= 1) + ylab("terapia intensiva variación diaria") +  labs(title = " Casos COVID-19, Argentina, 2020 by @larysar")


```

## Variación en el intervalo serial 

* Usamos los datos de @He2020 (77 casos) para estimar el intervalo serial (SI media de 5.8) y el $R_t$, hay 
que eliminar el par con ID=9 porque el infector y el infectado suceden el mismo día. Estos datos consisten en la fecha de inicio de los síntomas en casos primarios y la fecha de inicio de síntomas en casos secundarios (originados por los primarios)

```{r RefectivoSI_He, results=FALSE,echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache=TRUE,cache.extra = tools::md5sum(csv_fname)}

pair <- read_tsv("Data/pair_data_He2020.dat") %>% mutate( EL=dmy(EL),ER=dmy(ER),SL=dmy(SL)) %>% mutate(SL=as.integer(SL-EL),SR=as.integer(SL+1),EL=as.integer(0),ER=as.integer(1)) %>% select(-ID) %>% filter(SL-EL>0)

## fixing the random seeds
MCMC_seed <- 1
overall_seed <- 2
mcmc_control <- make_mcmc_control(seed = MCMC_seed, burnin = 1000)
dist <- "G"  # fitting a Gamma distribution for the SI
empirical_si_config <- make_config(list(si_parametric_distr = dist, 
    mcmc_control = mcmc_control, seed = overall_seed, n1 = 50, 
    n2 = 50))
ar_res_empirical_si <- estimate_R(incid, method = "si_from_data", 
    si_data = pair, config = empirical_si_config)

plot(ar_res_empirical_si, "SI")+ theme_bw()

plot(ar_res_empirical_si, "R")+ theme_bw() + labs(title = "Nro Reproductivo Efectivo Basado en 7 días", 
        subtitle = "COVID-19, Argentina, 2020 by @larysar") + theme_bw()

mu <- lapply(ar_res_empirical_si$SI.Moments,median)
sigma <- mu$Std
mu <- mu$Mean
```

La mediana del intervalo serial estimado es **mu =`r mu`** y la desviación **sigma =`r sigma`**, lo cual es diferente de lo reportado en el paper de @He2020 seguramente debido a que se usaron diferentes métodos. De ahora en adelante usaremos el intervalo serial estimado por nosotros.

## Estimaciones usando modelos log-lineales

La fase inicial de un brote, cuando se muestra en un gráfico de semi-log (el eje y con una transformación logarítmica), aparece (algo) lineal. Esto sugiere que podemos modelar el crecimiento y decaimiento epidémico, utilizando un modelo log-lineal simple de la forma:

$$log(y) = rt + b$$

donde $y$ es la incidencia, $r$ es la tasa de crecimiento, $t$ es el número de días desde un punto específico en el tiempo (generalmente el inicio del brote) y $b$ es la ordenada de origen. Se ajustan modelos separados para distintas fases de la curva de epidemia (datos de incidencia).

* Dividimos la curva de incidencia en dos partes, antes y despues del primer pico de incidencia que sucedió despues de la cuarentena (20/03/2020), que resultó el 30/03/2020. Tomamos esta fecha para determinar el $R_0$ antes de la cuarentena 


### Estimamos con los casos locales (no importados) para toda Argentina 

```{r log-linearlocal, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
require(incidence)
require(projections)

cor_incidence_peak <- as.Date("2020-03-30")   # Estimo que alli termina la fase exponencial inicial  


cor_incidence <- cor  %>% dplyr::select(fecha, localesdia) %>% uncount(localesdia)
cor_incidence_obj <- incidence::incidence(cor_incidence$fecha)

#cor_incidence_peak <- find_peak(cor_incidence_obj)

cor_incidence_fit <- incidence::fit(cor_incidence_obj, 
    split = cor_incidence_peak)


# plot the incidence data and the model fit
plot(cor_incidence_obj) %>% add_incidence_fit(cor_incidence_fit) + 
    labs(title = "Incidencia Observada y modelada para casos **locales** COVID-19", 
        subtitle = "Argentina, 2020 by @larysar") + theme_bw()  + geom_vline(xintercept = cor_incidence_peak,col = "red", lty = 2) 


```


* La tasa de crecimiento antes del pico **`r cor_incidence_peak`** fue **`r format(incidence::get_info(cor_incidence_fit, "r")[1],digits=2,nsmall=2)`** (95% CI `r format(incidence::get_info(cor_incidence_fit, "r.conf")[1,1],digits=2,nsmall=2)` - `r format(incidence::get_info(cor_incidence_fit, "r.conf")[1,2],digits=2,nsmall=2)`)

* La tasa de crecimiento después el pico fue **`r format(incidence::get_info(cor_incidence_fit, "r")[2],digits=2,nsmall=2)`** (95% CI `r format(incidence::get_info(cor_incidence_fit, "r.conf")[2,2],digits=3,nsmall=2)` - `r format(incidence::get_info(cor_incidence_fit, "r.conf")[2,1],digits=3,nsmall=2)`).

* El tiempo de duplicacion de la primer parte es es **`r format(incidence::get_info(cor_incidence_fit, "doubling")[1],digits=1,nsmall=1)` días** (95% CI `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[1,1],digits=1,nsmall=1)` - `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[1,2],digits=1,nsmall=1)` días)

* El tiempo de duplicación de la segunda parte **`r format(incidence::get_info(cor_incidence_fit, "doubling")[2],digits=1,nsmall=1)` días** (95% CI `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[2,1],digits=1,nsmall=1)` - `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[2,2],digits=1,nsmall=1)` días). 


## Proyecciones de incidencia para el total de casos Argentina

* Esta estimación de proyecciones requiere la estimación del R0 para las dos fases que definimos (con division en el primer pico después de la cuarentena `r cor_incidence_peak`), basado en [@Nouvellet2018]. Tomamos solamente los casos locales.  

* Utilizamos los datos sobre la incidencia diaria, _el intervalo de serial_ (tiempo entre el inicio de los infectores y los infectados) y el número de reproductivo, que se mantiene constante, para simular trayectorias de epidemia plausibles y proyectar la incidencia futura. Se basa en un proceso de ramificación donde la incidencia diaria sigue un proceso de Poisson determinado por una infecciosidad diaria, calculada como:

$$\lambda_t \sim Pois \left ( \sum_{s=1}^{t-1} y_s w(t-s) \right ) $$ 

donde $w()$ es la función de masa de probabilidad del intervalo serial, y $y_s$ es la incidencia en el tiempo $s$.

```{r proyectR0, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
require(epitrix)
require(distcrete)
# Serial interval estimated by Li2020
#mu <- 7.5 # days
#sigma <- 3.4 # days
#
param <- gamma_mucv2shapescale(mu, sigma / mu)
w <- distcrete("gamma", interval = 1,
                 shape = param$shape,
                 scale = param$scale, w = 0)
growth_R0 <- lm2R0_sample(cor_incidence_fit$before$model, w)

hist(growth_R0, col = "grey", border = "white", main = "Distribution of R0")
summary(growth_R0)

decay_R0 <- lm2R0_sample(cor_incidence_fit$after$model, w)
hist(decay_R0, col = "grey", border = "white", main = "Distribution of R0")
summary(decay_R0)

```

```{r proyect, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

set.seed(1)
pred_fwd_days <- 10
date_range <- 1:(which(get_dates(cor_incidence_obj) == cor_incidence_peak) - pred_fwd_days)
test_pred_growth <- project(cor_incidence_obj[date_range],
                            R = median(growth_R0),
                            si = w,
                            n_days = pred_fwd_days, n_sim = 1000)

# 
#
set.seed(1)
pred_fwd_days <- 10 # 5
date_range <- which(get_dates(cor_incidence_obj) == cor_incidence_peak):(length(get_dates(cor_incidence_obj)) - pred_fwd_days)
test_pred_decay <- project(cor_incidence_obj[date_range],
                            R = median(decay_R0),
                            si = w,
                            n_days = 30, n_sim = 1000)

plot(cor_incidence_obj) %>% add_projections(test_pred_growth, boxplots = FALSE) %>% add_projections(test_pred_decay, boxplots = FALSE) 

```


## El $R_0$ y la heterogeneidad de la epidemia

Habiendo hecho todos los calculos anteriores tenemos que aclarar que los análisis basados en el $R_0$ (el número de reproducción básico, el número esperado de casos secundarios producida por un caso primario durante su período infeccioso en una población completamente susceptible [@Kermack1927]) tienen una serie de susposiciones que no se cumplen [@Hebert-Dufresne2020].Esto se puede razonar de la siguiente forma, el $R_0$ nos dice el número de infecciones producidas por un caso pero ese numero promedio tiene una gran variación [@Lloyd-Smith2005]. Hay situaciones en las que se producen los eventos de super-propagación que están relacionadas con individuos que tienen mayor carga viral, o mayores contactos, o situaciones en las que se propicia la transmición (encuentros de muchas personas sin distancimiento ni protección). Es decir, puede ser engañoso mirar promedios provinciales o nacionales y celebrar si $R_0$ parece estar cayendo por debajo de 1 porque la epidemia podría estar causando estragos en lugares deteminados o entre grupos particulares. Digamos que incluso si $R_0$ está por debajo de 1 se pueden producir brotes grandes debido a la super-propagación o simplemente por casualidad. 


## Estimación de $R_t$ y tiempo de duplicación para Ciudad de Buenos Aires CABA


* La linea punteada marron vertical es pico de casos local, luego las lineas punteadas rojas son las fases de la cuarentena del gobierno nacional <https://www.argentina.gob.ar/coronavirus/aislamiento/fases>, hasta el ASPO/DISPO <https://www.boletinoficial.gob.ar/detalleAviso/primera/230245/20200608>.

* Datos a partir de los reportes del Ministerio de Salud 

```{r Rt-log-linearCABA, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache.extra = tools::md5sum(csv_fname)}

cor<-read_csv('https://docs.google.com/spreadsheets/d/16-bnsDdmmgtSxdWbVMboIHo5FRuz76DBxsz_BbsEVWA/export?format=csv&id=16-bnsDdmmgtSxdWbVMboIHo5FRuz76DBxsz_BbsEVWA&gid=0') %>% mutate(fecha=dmy(fecha))

#unique(cor$osm_admin_level_4)
dfCABA <- cor %>% filter( osm_admin_level_4 =="CABA") 
esProv <- estima_Re_from_df(dfCABA,"CABA",end_date = max(cor$fecha),nombre_fases = c("Cuarentena","Fase 2","Fase 3","Fase 3","ASPO"))

cor_incidence <- dfCABA  %>% dplyr::select(fecha, nue_casosconf_diff) %>% uncount(nue_casosconf_diff)
cor_incidence_obj <- incidence::incidence(cor_incidence$fecha, last_date=max(cor$fecha))

#cor_incidence_peak <- find_peak(cor_incidence_obj)
#cor_incidence_peak <- estimate_peak(cor_incidence_obj)
cor_incidence_peak <- as.Date("2020-03-30")   # Estimo que alli termina la fase exponencial inicial  

cor_incidence_fit <- incidence::fit(cor_incidence_obj, 
    split = cor_incidence_peak)


# plot the incidence data and the model fit
plot(cor_incidence_obj) %>% add_incidence_fit(cor_incidence_fit) + 
    labs(title = "Incidencia Observada y modelada para CABA COVID-19", 
        subtitle = "Argentina, 2020 by @larysar") + theme_bw()  + geom_vline(xintercept = cor_incidence_peak,col = "red", lty = 2) 

```

* La tasa de crecimiento antes del pico **`r cor_incidence_peak`** fue **`r format(incidence::get_info(cor_incidence_fit, "r")[1],digits=2,nsmall=2)`** (95% CI `r format(incidence::get_info(cor_incidence_fit, "r.conf")[1,1],digits=2,nsmall=2)` - `r format(incidence::get_info(cor_incidence_fit, "r.conf")[1,2],digits=2,nsmall=2)`)

* La tasa de crecimiento después el pico fue **`r format(incidence::get_info(cor_incidence_fit, "r")[2],digits=2,nsmall=2)`** (95% CI `r format(incidence::get_info(cor_incidence_fit, "r.conf")[2,2],digits=3,nsmall=2)` - `r format(incidence::get_info(cor_incidence_fit, "r.conf")[2,1],digits=3,nsmall=2)`).

* El tiempo de duplicación de la primer parte es es **`r format(incidence::get_info(cor_incidence_fit,"doubling")[1],digits=1,nsmall=1)` días** (95% CI `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[1,1],digits=1,nsmall=1)` - `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[1,2],digits=1,nsmall=1)` días)

* El tiempo de duplicación de la segunda parte **`r format(incidence::get_info(cor_incidence_fit, "doubling")[2],digits=1,nsmall=1)` días** (95% CI `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[2,1],digits=1,nsmall=1)` - `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[2,2],digits=1,nsmall=1)` días). 

### Proyecciones de Incidencia para CABA

```{r proyectR0CABA, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
require(epitrix)
require(distcrete)
# Serial interval estimated by Li2020
#mu <- 7.5 # days
#mu <- 6.6944741
#sigma <- 3.4 # days
#sigma <- 4.4140809
#
param <- gamma_mucv2shapescale(mu, sigma / mu)
w <- distcrete("gamma", interval = 1,
                 shape = param$shape,
                 scale = param$scale, w = 0)
growth_R0 <- lm2R0_sample(cor_incidence_fit$before$model, w)

hist(growth_R0, col = "grey", border = "white", main = "Distribution of R0")
summary(growth_R0)

decay_R0 <- lm2R0_sample(cor_incidence_fit$after$model, w)
hist(decay_R0, col = "grey", border = "white", main = "Distribution of R0")
summary(decay_R0)

```


```{r proyectCABA, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

set.seed(1)
pred_fwd_days <- 10
date_range <- 1:(which(get_dates(cor_incidence_obj) == cor_incidence_peak) - pred_fwd_days)
test_pred_growth <- project(cor_incidence_obj[date_range],
                            R = median(growth_R0),
                            si = w,
                            n_days = pred_fwd_days, n_sim = 1000)

# 
#
set.seed(1)
pred_fwd_days <- 10 # 5
date_range <- which(get_dates(cor_incidence_obj) == cor_incidence_peak):(length(get_dates(cor_incidence_obj)) - pred_fwd_days)
test_pred_decay <- project(cor_incidence_obj[date_range],
                            R = median(decay_R0),
                            si = w,
                            n_days = 30, n_sim = 1000)

plot(cor_incidence_obj) %>% add_projections(test_pred_growth, boxplots = FALSE) %>% add_projections(test_pred_decay, boxplots = FALSE) 


```



## Estimación de $R_t$ y tiempo de duplicación para Ciudad de Buenos Aires CABA a partir de Datos Abiertos


* Tomando los [Datos abiertos del ministerio de salud](http://datos.salud.gob.ar/dataset/covid-19-casos-registrados-en-la-republica-argentina/archivo/fd657d02-a33a-498b-a91b-2ef1a68b8d16) 

* Enlace de descarga directo <https://sisa.msal.gov.ar/datos/descargas/covid-19/files/Covid19Casos.csv>

* Última fecha de actualización `r  max(cor_nac$ultima_actualizacion)`

* Los datos se actualizan por día a las 17:45, para los calculos de $R_t$ tomo el día anterior debido a que para el ultimo día no se contabilizan todos los casos. 

```{r Rt-log-linearCABA_NAC, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache.extra = tools::md5sum(csv_fname1)}

# Datos de Casos de Gobierno Nacional 
#
# mutate(fecha=if_else(is.na(fis),fecha_apertura,fis))
#
corConf <- cor_nac %>% filter(residencia_provincia_nombre=="CABA",clasificacion_resumen=="Confirmado") %>% 
      mutate(fecha=fecha_diagnostico)

cor_incidence_obj <- corConf  %>% select(fecha)
cor_incidence_obj <- incidence::incidence(cor_incidence_obj$fecha,
                                          last_date=ymd(max(corConf$ultima_actualizacion))-1)

esProv <- estima_Re_from_df(cor_incidence_obj,"CABA Datos Abiertos MinSal",nombre_fases = c("Cuarentena","Fase 2","Fase 3","Fase 3","ASPO"))



# cor_incidence <- cor  %>% dplyr::select(fecha, CABAdia) %>% uncount(CABAdia)
# cor_incidence_obj <- incidence::incidence(cor_incidence$fecha, last_date=max(cor$fecha))
# cor_incidence <- corConf  %>% filter(!importado) %>% select(fecha)
# cor_incidence_obj <- incidence::incidence(cor_incidence$fecha, last_date=ymd('2020/05/19'))

#cor_incidence_peak <- find_peak(cor_incidence_obj)
#cor_incidence_peak <- estimate_peak(cor_incidence_obj)
cor_incidence_peak <- as.Date("2020-03-30")   # Estimo que alli termina la fase exponencial inicial  

cor_incidence_fit <- incidence::fit(cor_incidence_obj, 
    split = cor_incidence_peak)


# plot the incidence data and the model fit
plot(cor_incidence_obj) %>% add_incidence_fit(cor_incidence_fit) + 
    labs(title = "Incidencia Observada y modelada para CABA COVID-19", 
        subtitle = "Argentina, 2020 by @larysar") + theme_bw()  + geom_vline(xintercept = cor_incidence_peak,col = "red", lty = 2) 




```


Número total de casos al `r max(cor_nac$ultima_actualizacion)` = `r corConf %>% summarize(totcasos=n())`


* La tasa de crecimiento antes del pico **`r cor_incidence_peak`** fue **`r format(incidence::get_info(cor_incidence_fit, "r")[1],digits=2,nsmall=2)`** (95% CI `r format(incidence::get_info(cor_incidence_fit, "r.conf")[1,1],digits=2,nsmall=2)` - `r format(incidence::get_info(cor_incidence_fit, "r.conf")[1,2],digits=2,nsmall=2)`)

* La tasa de crecimiento después el pico fue **`r format(incidence::get_info(cor_incidence_fit, "r")[2],digits=2,nsmall=2)`** (95% CI `r format(incidence::get_info(cor_incidence_fit, "r.conf")[2,2],digits=3,nsmall=2)` - `r format(incidence::get_info(cor_incidence_fit, "r.conf")[2,1],digits=3,nsmall=2)`).

* El tiempo de duplicación de la primer parte es es **`r format(incidence::get_info(cor_incidence_fit,"doubling")[1],digits=1,nsmall=1)` días** (95% CI `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[1,1],digits=1,nsmall=1)` - `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[1,2],digits=1,nsmall=1)` días)

* El tiempo de duplicación de la segunda parte **`r format(incidence::get_info(cor_incidence_fit, "doubling")[2],digits=1,nsmall=1)` días** (95% CI `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[2,1],digits=1,nsmall=1)` - `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[2,2],digits=1,nsmall=1)` días). 


## Estimación de $R_t$ y tiempo de duplicación para Prov. de Buenos Aires

* Utilizamos los reportes del Ministerio de Salud. La linea punteada marron vertical es el primer pico de casos local para separar la 1ra fase, de 2da fase. Las lineas rojas es el inicio de la quarentena y las fases del gobierno nacional. 

```{r Rt-log-linearPBA, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache.extra = tools::md5sum(csv_fname)}

dfCABA <- cor %>% filter( osm_admin_level_4 =="Buenos Aires", is.na(osm_admin_level_8) | osm_admin_level_8!="Malvinas") 
esProv <- estima_Re_from_df(dfCABA,"Buenos Aires",end_date = max(cor$fecha),nombre_fases = c("Cuarentena","Fase 2","Fase 3","Fase 3","ASPO"))

```

* Luego estimamos modelos log-lineales

```{r Rt-log-linearPBA_NAC, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache.extra = tools::md5sum(csv_fname)}

# Tomo casos totales para el ajuste exponencial
# cor_incidence <- corConf  %>% filter(!importado) %>% select(fecha) 
cor_incidence <- dfCABA  %>% dplyr::select(fecha, nue_casosconf_diff) %>% uncount(nue_casosconf_diff)
cor_incidence_obj <- incidence::incidence(cor_incidence$fecha, last_date=max(cor$fecha))
#cor_incidence_peak <- find_peak(cor_incidence_obj)
cor_incidence_peak <- as.Date("2020-03-30")   # Estimo que alli termina la fase exponencial inicial  

cor_incidence_fit <- incidence::fit(cor_incidence_obj, 
    split = cor_incidence_peak)


# plot the incidence data and the model fit
plot(cor_incidence_obj) %>% add_incidence_fit(cor_incidence_fit) + 
    labs(title = "Incidencia Observada y modelada para Prov. Buenos Aires COVID-19", 
        subtitle = "Argentina, 2020 by @larysar") + theme_bw()  + geom_vline(xintercept = cor_incidence_peak,col = "red", lty = 2) 

```

* La tasa de crecimiento antes del pico **`r cor_incidence_peak`** fue **`r format(incidence::get_info(cor_incidence_fit, "r")[1],digits=2,nsmall=2)`** (95% CI `r format(incidence::get_info(cor_incidence_fit, "r.conf")[1,1],digits=2,nsmall=2)` - `r format(incidence::get_info(cor_incidence_fit, "r.conf")[1,2],digits=2,nsmall=2)`)

* La tasa de crecimiento después el pico fue **`r format(incidence::get_info(cor_incidence_fit, "r")[2],digits=2,nsmall=2)`** (95% CI `r format(incidence::get_info(cor_incidence_fit, "r.conf")[2,2],digits=3,nsmall=2)` - `r format(incidence::get_info(cor_incidence_fit, "r.conf")[2,1],digits=3,nsmall=2)`).

* El tiempo de duplicación de la primer parte es es **`r format(incidence::get_info(cor_incidence_fit,"doubling")[1],digits=1,nsmall=1)` días** (95% CI `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[1,1],digits=1,nsmall=1)` - `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[1,2],digits=1,nsmall=1)` días)


* El tiempo de duplicación de la segunda parte **`r format(incidence::get_info(cor_incidence_fit, "doubling")[2],digits=1,nsmall=1)` días** (95% CI `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[2,1],digits=1,nsmall=1)` - `r format(incidence::get_info(cor_incidence_fit, "doubling.conf")[2,2],digits=1,nsmall=1)` días). 

### Calculo de Proyecciones de Incidencia para Prov. De Buenos Aires

```{r proyectR0PBA, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}
require(epitrix)
require(distcrete)
# Serial interval estimated by Li2020
#mu <- 7.5 # days
#sigma <- 3.4 # days
#
param <- gamma_mucv2shapescale(mu, sigma / mu)
w <- distcrete("gamma", interval = 1,
                 shape = param$shape,
                 scale = param$scale, w = 0)
growth_R0 <- lm2R0_sample(cor_incidence_fit$before$model, w)

hist(growth_R0, col = "grey", border = "white", main = "Distribution of R0")
summary(growth_R0)

decay_R0 <- lm2R0_sample(cor_incidence_fit$after$model, w)
hist(decay_R0, col = "grey", border = "white", main = "Distribution of R0")
summary(decay_R0)

```


```{r proyectPBA, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE}

set.seed(1)
pred_fwd_days <- 5
date_range <- 1:(which(get_dates(cor_incidence_obj) == cor_incidence_peak) - pred_fwd_days)
test_pred_growth <- project(cor_incidence_obj[date_range],
                            R = median(growth_R0),
                            si = w,
                            n_days = pred_fwd_days, n_sim = 1000)

# 
#
set.seed(1)
pred_fwd_days <- 15 # 5
date_range <- which(get_dates(cor_incidence_obj) == cor_incidence_peak):(length(get_dates(cor_incidence_obj)) - pred_fwd_days)
test_pred_decay <- project(cor_incidence_obj[date_range],
                            R = median(decay_R0),
                            si = w,
                            n_days = 30, n_sim = 1000)

plot(cor_incidence_obj) %>% add_projections(test_pred_growth, boxplots = FALSE) %>% add_projections(test_pred_decay, boxplots = FALSE) 

```

## Estimación de $R_t$ por provincia 

* Utilizamos los datos abiertos del Ministerio de Salud. Las lineas rojas son el inicio de la quarentena y las fases del gobierno nacional. 

```{r Rt-provincia, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache.extra = tools::md5sum(csv_fname1)}


corR <- cor_nac %>% filter(clasificacion_resumen=="Confirmado") %>% 
      mutate(fecha=fecha_diagnostico,residencia_provincia_nombre=ifelse(residencia_provincia_nombre=="SIN ESPECIFICAR",carga_provincia_nombre,residencia_provincia_nombre)) %>% filter(residencia_provincia_nombre %in% c("Chaco","CABA","Buenos Aires","Neuquén", "Río Negro","Chubut")) %>%
      group_by(residencia_provincia_nombre ) %>% 
      do( {
          cor_incidence_obj <- select(. , fecha)
          cor_incidence_obj <- incidence::incidence(cor_incidence_obj$fecha,
                                          last_date=ymd(max(.$ultima_actualizacion))-1)

          esProv <- estima_Re_from_df(cor_incidence_obj,"Datos Abiertos MinSal",nombre_fases = c("Cuarentena","Fase 2","Fase 3","Fase 3","ASPO"),plot = FALSE)
          rdf <- esProv[[2]]$R %>% rename(medianR = `Median(R)`,quantile025 = `Quantile.0.025(R)`,quantile975=`Quantile.0.975(R)`)
          fechas <- esProv[[1]]$dates
          rdf <- bind_cols(rdf, fecha = fechas[rdf$t_end]) 
      })

saveRDS(corR,"Data/corR.rds")
#corR <- readRDS("Data/corR.rds")

nombre_fases <- c("Cuarentena","Fase 2","Fase 3","Fase 4","ASPO/DISPO")
fases <- tibble(fecha=c(ymd("2020-03-20"),ymd("2020-04-13"),ymd("2020-04-25"),ymd("2020-05-10"),ymd("2020-06-08")),
                  nombre=nombre_fases)
ggplot(corR, aes(fecha,medianR)) + geom_line() + geom_ribbon(aes(ymin=quantile025,ymax=quantile975),alpha=0.2) +
  scale_y_continuous(trans="log2") + geom_hline(yintercept = 1, linetype=3) + 
  scale_x_date(date_breaks = "1 week",date_labels =  "%b-%d") + theme(axis.text.x=element_text(angle=60, hjust=1)) + 
  facet_wrap(~residencia_provincia_nombre) + geom_vline(data= fases, aes(xintercept = fecha), col = "red", lty = 3)  +
  geom_text(data = fases, mapping = aes(label = nombre, x=fecha,y = 0), angle = 60, hjust = 0,size=3) + ylab("R effectivo (7 Días)") + xlab("") + coord_cartesian(ylim=c(0.1,8))


```

## Chaco: Gran resistencia 

* El área de gran resistencia (Departamento San Fernando), tiene un gran nro de afectados y debido al interés calculamos la cantidad de fallecidos por millon y el $R_t$.

* Con un población de 390874 (Censo 2010 <http://www.citypopulation.de/php/argentina-chaco_s.php?adm2id=22140>),  

```{r Incid-provincia-CHACO, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache.extra = tools::md5sum(csv_fname1)}

corI <- cor_nac %>% mutate(fecha=ymd(fecha_apertura),
                           residencia_provincia_nombre=ifelse(residencia_provincia_nombre=="SIN ESPECIFICAR",carga_provincia_nombre,residencia_provincia_nombre)) %>% filter(clasificacion_resumen=="Confirmado", residencia_provincia_nombre %in% c("Chaco"),fecha < ultima_actualizacion,residencia_departamento_nombre=="San Fernando") %>% group_by(fallecido) %>% summarise(fecha=max(fecha),n=n(), porMillon=n/390874*1000000)

knitr::kable(corI,digits = 0)

corI <- cor_nac %>% mutate(fecha=ymd(fecha_diagnostico),
                           residencia_provincia_nombre=ifelse(residencia_provincia_nombre=="SIN ESPECIFICAR",carga_provincia_nombre,residencia_provincia_nombre)) %>% filter(clasificacion_resumen=="Confirmado", residencia_provincia_nombre %in% c("Chaco"),fecha < ultima_actualizacion,residencia_departamento_nombre=="San Fernando")

cor_incidence_obj <- select(corI , fecha)
cor_incidence_obj <- incidence::incidence(cor_incidence_obj$fecha,
                                          last_date=ymd(max(corI$ultima_actualizacion))-1)

esProv <- estima_Re_from_df(cor_incidence_obj,"Datos Abiertos MinSal",nombre_fases = c("Cuarentena","Fase 2","Fase 3","Fase 3","ASPO"),plot = TRUE)

```


## Comparación de datos de Incidencia (nro. de casos por día) por Provincia 

* Inicialmente utilizamos los datos abiertos del Ministerio de Salud. Las lineas rojas son el inicio de la quarentena y las fases del gobierno nacional.

* Los datos cargados a partir de los reportes del Ministerio de Salud, tienen diferencias con los "Datos abiertos del Ministerio de Salud" en este último caso utilizamos las fechas de diagnóstico y la provincia de residencia, cuando lar provincia de residencia está SIN ESPECIFICAR se toma la provincia de carga. 

```{r Incid-provincia, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache.extra = tools::md5sum(csv_fname1)}

corI <- cor_nac %>% mutate(fecha=ymd(fecha_apertura),
                           residencia_provincia_nombre=ifelse(residencia_provincia_nombre=="SIN ESPECIFICAR",carga_provincia_nombre,residencia_provincia_nombre)) %>% filter(clasificacion_resumen=="Confirmado", residencia_provincia_nombre %in% c("Chaco","CABA","Buenos Aires","Neuquén", "Río Negro","Chubut"),fecha < ultima_actualizacion) %>% group_by(residencia_provincia_nombre,fecha) %>% summarise( Casos = n()) %>% mutate(datos="Abiertos")

ggplot(corI, aes(fecha,Casos)) + geom_bar(stat="identity") +  
  scale_x_date(date_breaks = "1 week",date_labels =  "%b-%d") + theme(axis.text.x=element_text(angle=60, hjust=1)) + 
  facet_wrap(~residencia_provincia_nombre, scales="free_y") + geom_vline(data= fases, aes(xintercept = fecha), col = "red", lty = 3)  +
  geom_text(data = fases, mapping = aes(label = nombre, x=fecha,y = 0), angle = 60, hjust = 0,size=3) + ylab("Casos") + xlab("") 

corI1 <- cor %>% mutate(fecha=ymd(fecha)) %>% filter(osm_admin_level_4 %in% c("Chaco","CABA","Buenos Aires","Neuquén", "Río Negro","Chubut"),fecha <= max(corI$fecha)) %>% select(osm_admin_level_4,fecha,nue_casosconf_diff) %>% rename(Casos=nue_casosconf_diff,residencia_provincia_nombre=osm_admin_level_4) %>% mutate(datos="Reportes")
corI <- bind_rows(corI,corI1)

ggplot(corI, aes(fecha,Casos,colour=datos)) + geom_line() +   facet_wrap(~residencia_provincia_nombre, scales="free_y") + 
  scale_x_date(date_breaks = "1 week",date_labels =  "%b-%d") + theme(axis.text.x=element_text(angle=60, hjust=1)) + ylab("Casos") + xlab("") + scale_color_viridis_d() +  theme(legend.position="bottom") + ggtitle(paste("Comparación Datos abiertos y Reportes al", max(corI$fecha)))

corI1 <- corI %>%  pivot_wider(names_from = datos, values_from = Casos, values_fn = list(Casos = sum)) %>% arrange(fecha)
knitr::kable( corI1 %>% group_by(residencia_provincia_nombre) %>% summarise(fecha=max(fecha), Abiertos= sum(Abiertos, na.rm = TRUE), Reportes = sum(Reportes, na.rm = TRUE)) )


```

## Parámetros a partir de Datos Abiertos por Provincia

* Arreglo provicia de residencia SIN ESPECIFICAR asumiendo provincia de carga
* Fallecidos sin fecha de hospitalización asumo que fueron hospitalizados.
* Calculo de días de hospitalización solamente para los fallecidos.
* Dias pre-hospitalización: desde inicio de síntomas hasta hospitalización.

```{r Letal-provincia, echo=FALSE, tidy=TRUE, message=FALSE, warning=FALSE,cache.extra = tools::md5sum(csv_fname1)}
#names(cor_nac)
# 
# Corrige los casos que se interno en CUI pero no tiene fecha internacion en hospital
#
#
cor_conf <- cor_nac %>% filter(clasificacion_resumen=="Confirmado") %>% mutate_at(vars(starts_with("fecha")),ymd) %>% mutate( 
                    dias_hospitalizacion = fecha_fallecimiento-fecha_internacion,
                    dias_pre_hospitalizacion = fecha_internacion - fecha_inicio_sintomas, 
                    hospitalizado= !is.na(fecha_internacion),
                    residencia_provincia_nombre=ifelse(residencia_provincia_nombre=="SIN ESPECIFICAR",carga_provincia_nombre,residencia_provincia_nombre))

#cor_conf %>% filter(residencia_provincia_nombre == "Tierra del Fuego", cuidado_intensivo=="SI")
#cor_conf %>% filter(carga_provincia_nombre == "Tierra del Fuego", cuidado_intensivo=="SI")

cor_FallRec <- cor_conf %>% filter(fallecido=="SI") %>% group_by(residencia_provincia_nombre,hospitalizado) %>%
  summarise(edad=median(edad, na.rm = TRUE),dias_hospitalizacion=median(dias_hospitalizacion, na.rm = TRUE),n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100)) %>% filter(!hospitalizado)  %>% arrange(desc(n))

knitr::kable(select(cor_FallRec, - dias_hospitalizacion, - hospitalizado),caption = "Tabla 1: Fallecidos sin fecha de hospitalización")

cor_FallRec <- cor_conf %>% filter(fallecido=="SI") %>% group_by(hospitalizado) %>%
  summarise(edad=median(edad, na.rm = TRUE),dias_hospitalizacion=median(dias_hospitalizacion, na.rm = TRUE),n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100,2)) %>% filter(!hospitalizado)  %>% arrange(desc(n))

knitr::kable(select(cor_FallRec, - dias_hospitalizacion, - hospitalizado),caption = "Tabla 2:  TOTAL: Fallecidos sin fecha de hospitalización")


#
# Arreglo la hospitalizacion de fallecidos
#
cor_conf <- cor_conf %>% mutate(hospitalizado = ifelse(fallecido=="SI",TRUE,hospitalizado))

cor_FallRec <- cor_conf  %>% filter(hospitalizado) %>%
  group_by(residencia_provincia_nombre,fallecido) %>% 
  summarise(edad=median(edad, na.rm = TRUE),dias_hospitalizacion=median(dias_hospitalizacion, na.rm = TRUE),
            dias_pre_hospitalizacion=median(dias_pre_hospitalizacion, na.rm = TRUE), n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100)) %>% filter(fallecido=="SI")  %>% arrange(desc(n))

knitr::kable(select(cor_FallRec, -fallecido),caption = "Tabla 3: Proporcion Fallecidos con respecto a hospitalizados")


cor_FallRec <- cor_conf  %>% filter(hospitalizado) %>%
  group_by(residencia_provincia_nombre,fallecido,cuidado_intensivo) %>% 
  summarise(edad=median(edad, na.rm = TRUE),dias_hospitalizacion=median(dias_hospitalizacion, na.rm = TRUE),
            dias_pre_hospitalizacion=median(dias_pre_hospitalizacion, na.rm = TRUE), n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100))  

knitr::kable(select(cor_FallRec,residencia_provincia_nombre,fallecido,cuidado_intensivo,everything()),caption = "Tabla 4: De Hospitalizados cuantos Fallecen y fueron a Cuidado Intensivo, o no")


cor_FallRec <- cor_conf  %>%  group_by(residencia_provincia_nombre,hospitalizado) %>% 
  summarise(edad=median(edad, na.rm = TRUE),n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100)) %>% filter(hospitalizado) %>% arrange(desc(n))

knitr::kable(select(cor_FallRec, - hospitalizado),caption = "Tabla 5: Proporción Hospitalizados con respecto a casos")

# cor_FallRec <- cor_conf %>% filter(residencia_provincia_nombre == "Mendoza")

corLetalidad <- cor_conf %>% group_by(residencia_provincia_nombre,fallecido) %>% summarise(n=n()) %>%mutate(Porcentaje = round( n / sum(n) * 100)) %>% filter(fallecido=="SI")  %>% arrange(desc(n))

knitr::kable(select(corLetalidad, -fallecido),caption = "Tabla 6: Letalidad Proporción Fallecidos con respecto a casos")


cor_FallRec <- cor_conf  %>% filter(hospitalizado) %>%
  group_by(fallecido) %>% 
  summarise(edad=median(edad, na.rm = TRUE),dias_hospitalizacion=median(dias_hospitalizacion, na.rm = TRUE),
            dias_pre_hospitalizacion=median(dias_pre_hospitalizacion, na.rm = TRUE), n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100,2)) 
knitr::kable(cor_FallRec,caption = "Tabla 7: TOTAL: Proporcion Fallecidos con respecto a hospitalizados")


cor_FallRec <- cor_conf  %>% filter(hospitalizado) %>%
  group_by(cuidado_intensivo) %>% 
  summarise(edad=median(edad, na.rm = TRUE),dias_hospitalizacion=median(dias_hospitalizacion, na.rm = TRUE),
            dias_pre_hospitalizacion=median(dias_pre_hospitalizacion, na.rm = TRUE), n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100,2)) 
knitr::kable(cor_FallRec,caption = "Tabla 8: TOTAL: Proporcion Cuidado Intensivo con respecto a hospitalizados")

cor_FallRec <- cor_conf  %>% filter(hospitalizado) %>%
  group_by(fallecido,cuidado_intensivo) %>% 
  summarise(edad=median(edad, na.rm = TRUE),dias_hospitalizacion=median(dias_hospitalizacion, na.rm = TRUE),
            dias_pre_hospitalizacion=median(dias_pre_hospitalizacion, na.rm = TRUE), n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100,2))  
knitr::kable(cor_FallRec,caption = "Tabla 9: TOTAL:  De Hospitalizados cuantos Fallecen y fueron a Cuidado Intensivo, o no")

cor_FallRec <- cor_conf  %>% filter(cuidado_intensivo=="SI") %>%
  group_by(fallecido) %>% 
  summarise(edad=median(edad, na.rm = TRUE),dias_hospitalizacion=median(dias_hospitalizacion, na.rm = TRUE),
            dias_pre_hospitalizacion=median(dias_pre_hospitalizacion, na.rm = TRUE), n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100,2))  
knitr::kable(cor_FallRec,caption = "Tabla 10: TOTAL:  De Cuidado intensivo cuantos Fallecen")

corLetalidad <- cor_conf %>% group_by(fallecido) %>% summarise(n=n()) %>%mutate(Porcentaje = round( n / sum(n) * 100,2))
knitr::kable(corLetalidad,caption = "Tabla 11: Letalidad Proporción Fallecidos con respecto a casos")

cor_FallRec <- cor_conf  %>%  group_by(hospitalizado) %>% 
  summarise(edad=median(edad, na.rm = TRUE),n=n()) %>%
  mutate(Porcentaje = round(n / sum(n) * 100)) %>% filter(hospitalizado) %>% arrange(desc(n))

knitr::kable(select(cor_FallRec, - hospitalizado),caption = "Tabla 12: Proporción Hospitalizados con respecto a casos")

```
 
## Bibliografía
